%%
%% This is file `runverbatim.sty',
%% generated with the docstrip utility.
%%
%% The original source files were:
%%
%% runverbatim.dtx  (with options: `package')
%% 
%% This is a generated file.
%% 
%% Copyright (C) 2014 by Timothy Bourke <tim@tbrk.org>
%%                    and Marc Pouzet <pouzet@ens.fr>
%% 
%% This file may be distributed and/or modified under the conditions of
%% the LaTeX Project Public License, either version 1.2 of this license
%% or (at your option) any later version.  The latest version of this
%% license is in:
%% 
%%    http://www.latex-project.org/lppl.txt
%% 
%% and version 1.2 or later is part of all distributions of LaTeX version
%% 1999/12/01 or later.
%% 
\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{runverbatim}
   [2014/02/14 v1.0 compile code samples and insert the results]
\RequirePackage{keyval}
\RequirePackage{kvoptions}
\RequirePackage{fancyvrb}
\RequirePackage{color}
\RequirePackage{listings}
\makeatletter
\lst@RequireAspects{writefile}
\SetupKeyvalOptions{family=RVRB,prefix=RVRB@}
\makeatother

\makeatletter
\newcounter{runverbatim}
\newif\ifRVRB@fileexists
\DeclareBoolOption{withresult}
\DeclareComplementaryOption{withoutresult}{withresult}
\def\RVRB@pkg@verbopts{}
\DeclareVoidOption{skipone}
    {\edef\RVRB@pkg@verbopts{\RVRB@pkg@verbopts,firstline=2}}
\DeclareVoidOption{skiptwo}
    {\edef\RVRB@pkg@verbopts{\RVRB@pkg@verbopts,firstline=3}}
\DeclareDefaultOption
    {\edef\RVRB@pkg@verbopts{\RVRB@pkg@verbopts,\CurrentOption}}
\DeclareStringOption[]{codestyle}
\DeclareStringOption[formatcom=\em]{msgstyle}
\DeclareStringOption[formatcom=\em]{errstyle}
\DeclareStringOption{subdir}
\DeclareStringOption[runverbatim]{prefix}
\DeclareStringOption[.ml]{ext}
\DeclareStringOption[\#]{prompt}
\DeclareStringOption[ocamlc]{compiler}
\DeclareStringOption{compilerflags}
\DeclareStringOption[-i]{lastflags}
\DeclareStringOption[open]{includecmd}
\def\runverbatimsetup{\kvsetkeys{RVRB}}
\ProcessKeyvalOptions*
\newwrite\RVRB@samplefile
\openout\RVRB@samplefile=\jobname.rvrb
\AtEndDocument{\closeout\RVRB@samplefile}
\write\RVRB@samplefile{subdir=\RVRB@subdir/}
\write\RVRB@samplefile{prefix=\RVRB@prefix}
\write\RVRB@samplefile{ext=\RVRB@ext}
\write\RVRB@samplefile{compiler=\RVRB@compiler}
\write\RVRB@samplefile{compilerflags=\RVRB@compilerflags}
\write\RVRB@samplefile{lastflags=\RVRB@lastflags}
\write\RVRB@samplefile{includecmd=\RVRB@includecmd}
\newcommand{\RVRB@logsample}[2]{%
  \edef\RVRB@tolog{#1:#2 [page=\noexpand\thepage] [line=\the\inputlineno]}%
  \expandafter\write\expandafter\RVRB@samplefile\expandafter{\RVRB@tolog}%
}
\newif\ifrunverbatim
\newcommand{\setrunverbatimcmd}[1]{%
    \global\def\runverbatimcmd{\emph{\RVRB@prompt{#1}}}}

\def\RunVerbatimMsg{\FV@Environment{}{RunVerbatimMsg}}
\def\FVB@RunVerbatimMsg{\FVB@SaveVerbatim{RunVerbatimMsg}}
\let\FVE@RunVerbatimMsg\FVE@SaveVerbatim
\DefineVerbatimEnvironment{RunVerbatimMsg}{RunVerbatimMsg}{}

\def\RunVerbatimErr{\FV@Environment{}{RunVerbatimErr}}
\def\FVB@RunVerbatimErr{\FVB@SaveVerbatim{RunVerbatimErr}}
\let\FVE@RunVerbatimErr\FVE@SaveVerbatim
\DefineVerbatimEnvironment{RunVerbatimErr}{RunVerbatimErr}{}

\newcommand{\runverbatimfile}{\RVRB@prefix\RVRB@ext}
\newif\ifRVRB@shouldfail
\newif\ifRVRB@showcode
\edef\RVRB@precontinue{}
\define@key{RVRB@envkeys}{continue}[]{\edef\RVRB@continue{\RVRB@precontinue}}
\define@key{RVRB@envkeys}{include}{%
  \edef\RVRB@continue{\RVRB@continue\space\@ifundefined{RVRB@deps@#1}%
    {#1}{\csname RVRB@deps@#1\endcsname}}}

\define@key{RVRB@envkeys}{fail}[]{\RVRB@shouldfailtrue}
\define@key{RVRB@envkeys}{label}{\edef\RVRB@label{#1}}
\define@key{RVRB@envkeys}{skipnone}[]{\edef\RVRB@verbopts{\RVRB@verbopts,firstline=1}}
\define@key{RVRB@envkeys}{skipone}[]{\edef\RVRB@verbopts{\RVRB@verbopts,firstline=2}}
\define@key{RVRB@envkeys}{skiptwo}[]{\edef\RVRB@verbopts{\RVRB@verbopts,firstline=3}}
\define@key{RVRB@envkeys}{hide}[]{\RVRB@showcodefalse}
\define@key{RVRB@envkeys}{withresult}[]{\RVRB@withresulttrue}
\define@key{RVRB@envkeys}{withoutresult}[]{\RVRB@withresultfalse}
\lstnewenvironment{runverbatim}[1][]
  {%
    \RVRB@shouldfailfalse%
    \RVRB@showcodetrue%
    \let\RVRB@label\@undefined%
    \edef\RVRB@continue{}%
    \let\RVRB@verbopts\RVRB@pkg@verbopts%
    \def\@currentlabel{\therunverbatim}%
    \setkeys{RVRB@envkeys}{#1}%
    \RVRB@logsample{\arabic{runverbatim}}{\RVRB@continue\ifRVRB@shouldfail\space[fail]\fi}%
    \global\edef\RVRB@precontinue{\RVRB@continue\space\arabic{runverbatim}}%
    \@ifundefined{RVRB@label}{}{%
    \global\expandafter\edef\csname RVRB@deps@\RVRB@label\endcsname{\RVRB@precontinue}}%
    \edef\RVRB@num{%
        \ifnum\value{runverbatim}<1000 0\fi
        \ifnum\value{runverbatim}<100  0\fi
        \ifnum\value{runverbatim}<10   0\fi
        \arabic{runverbatim}}%
    \stepcounter{runverbatim}%
    \def\RVRB@file{\RVRB@subdir/\RVRB@prefix\RVRB@num}%
    \global\let\runverbatimcmd\@undefined%
    \global\let\FV@SV@RunVerbatimMsg\@undefined%
    \global\let\FV@SV@RunVerbatimErr\@undefined%
    \runverbatimtrue%
    \setbox\@tempboxa\hbox\bgroup%
    \lst@BeginWriteFile{\RVRB@file\RVRB@ext}%
  }
  {%
    \lst@EndWriteFile%
    \egroup%
    \ifRVRB@showcode
        \bgroup%
        %\expandafter\lstset\expandafter{\RVRB@verbopts}%
        %\lstinputlisting{\@file}
        \expandafter\fvset\expandafter{\RVRB@verbopts}%
        \expandafter\VerbatimInput\expandafter[\RVRB@codestyle]{\RVRB@file\RVRB@ext}%
        \egroup%
    \fi
    \edef\RVRB@none{$\langle$Cannot load \RVRB@file.tex!$\rangle$}
    \InputIfFileExists{\RVRB@file.tex}{\RVRB@fileexiststrue}{\RVRB@fileexistsfalse}
    \ifRVRB@fileexists
        \@ifundefined{FV@SV@RunVerbatimMsg}
          {}{\global\def\runverbatimmsg{%
             \expandafter\UseVerbatim\expandafter[\RVRB@msgstyle]{RunVerbatimMsg}}}
        \@ifundefined{FV@SV@RunVerbatimErr}
          {}{\global\def\runverbatimerr{%
             \expandafter\UseVerbatim\expandafter[\RVRB@errstyle]{RunVerbatimErr}}}
        \ifRVRB@shouldfail
            \ifrunverbatim
                \PackageWarning{runverbatim}
                    {Compilation of \RVRB@file\RVRB@ext\space should have failed}
                \UseVerbatim[frame=single,
                             label=Unexpected success,
                             rulecolor=\color{red}]{RunVerbatimMsg}
            \else
                \ifRVRB@withresult
                    {\setlength{\partopsep}{0em}\runverbatimerr}
                \fi
            \fi
        \else
            \ifrunverbatim
                \ifRVRB@withresult
                    {\setlength{\partopsep}{0em}\runverbatimmsg}
                \fi
            \else
                \PackageWarning{runverbatim}
                    {Compilation of \RVRB@file\RVRB@ext\space should not have failed}
                \UseVerbatim[frame=single,
                             label=Unexpected failure,
                             rulecolor=\color{red}]{RunVerbatimErr}
            \fi
        \fi
    \else
        \PackageWarning{runverbatim}{Cannot load \RVRB@file.tex}
        \global\let\runverbatimcmd\RVRB@none
        \global\let\runverbatimmsg\RVRB@none
        \global\let\runverbatimerr\RVRB@none
    \fi
  }
\makeatother
\clearpage
\endinput
%%
%% End of file `runverbatim.sty'.
